<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Speeky OS | Media Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00f2ff; --bg: #030406; --glass: rgba(255, 255, 255, 0.05); --border: rgba(255, 255, 255, 0.1); }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; }

        /* –§–û–ù */
        .bg { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 20% 30%, #001f22 0%, #030406 100%); }

        /* –ü–†–ò–õ–û–ñ–ï–ù–ò–ï */
        #app { display: flex; flex-direction: column; height: 100vh; }
        .screen { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 200px; display: none; }
        .screen.active { display: flex; flex-direction: column; }

        /* –ú–ï–°–°–ï–î–ñ–ò */
        #chat-flow { display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 85%; padding: 12px; border-radius: 20px; position: relative; animation: pop 0.3s ease; }
        .msg b { display: block; font-size: 10px; opacity: 0.5; margin-bottom: 5px; }
        .msg.sent { align-self: flex-end; background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .msg.received { align-self: flex-start; background: var(--glass); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        
        /* –ö–û–ù–¢–ï–ù–¢ –í–ù–£–¢–†–ò */
        .msg img { max-width: 100%; border-radius: 12px; margin-top: 5px; }
        .msg video { max-width: 100%; border-radius: 12px; }
        .msg audio { width: 200px; height: 35px; margin-top: 5px; filter: invert(1); }
        .circle-vid { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }

        /* –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .ui-bottom { position: fixed; bottom: 20px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .media-drawer { width: 92%; max-width: 500px; background: rgba(20,22,28,0.95); border-radius: 25px; padding: 15px; display: none; grid-template-columns: repeat(4, 1fr); gap: 10px; border: 1px solid var(--border); }
        .media-drawer.active { display: grid; }
        .media-btn { background: var(--glass); border: none; padding: 15px; border-radius: 15px; color: #fff; font-size: 20px; cursor: pointer; }

        .input-row { width: 92%; max-width: 500px; background: rgba(15,17,23,0.9); backdrop-filter: blur(20px); border-radius: 35px; padding: 8px; display: flex; align-items: center; border: 1px solid var(--border); }
        .input-row input { background: none; border: none; flex: 1; color: #fff; padding: 10px 15px; outline: none; }
        .btn-act { width: 42px; height: 42px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-left: 5px; }
        .btn-plus { background: var(--glass); color: #fff; }
        .btn-send { background: var(--accent); color: #000; font-weight: 800; }

        @keyframes pop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div class="bg"></div>

    <div id="app">
        <section id="sc-chat" class="screen active">
            <h1 style="margin-bottom:20px;">Speeky Media</h1>
            <div id="chat-flow"></div>
        </section>

        <div class="ui-bottom">
            <div class="media-drawer" id="drawer">
                <button class="media-btn" onclick="triggerFile('image/*')">üñºÔ∏è</button>
                <button class="media-btn" onclick="triggerFile('video/*')">üìπ</button>
                <button class="media-btn" onclick="startVoice()">üéôÔ∏è</button>
                <button class="media-btn" onclick="startCircle()">‚≠ï</button>
            </div>
            <div class="input-row">
                <button class="btn-act btn-plus" onclick="document.getElementById('drawer').classList.toggle('active')">+</button>
                <input type="text" id="m-text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="btn-act btn-send" onclick="send('text')">></button>
            </div>
        </div>
    </div>

    <input type="file" id="f-picker" style="display:none" onchange="uploadFile(this)">

    <script>
        const API = 'https://my-chat-itp3.onrender.com';
        const user = JSON.parse(localStorage.getItem('spk_user')) || { nick: 'Yaroslav', email: 'yara@test.com' };
        let lastCount = 0;
        let mediaRecorder;

        // –í–´–ë–û–† –§–ê–ô–õ–ê (–§–û–¢–û/–í–ò–î–ï–û)
        function triggerFile(type) {
            const p = document.getElementById('f-picker');
            p.accept = type;
            p.click();
        }

        async function uploadFile(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const type = file.type.startsWith('image') ? 'img' : 'vid';
                send(type, e.target.result);
            };
            reader.readAsDataURL(file);
            document.getElementById('drawer').classList.remove('active');
        }

        // –û–¢–ü–†–ê–í–ö–ê
        async function send(type, content = null) {
            const inp = document.getElementById('m-text');
            const msg = {
                nick: user.nick,
                email: user.email.toLowerCase(),
                type: type, // text, img, vid, audio, circle
                text: type === 'text' ? inp.value : null,
                media: content
            };
            if(type === 'text' && !inp.value.trim()) return;
            if(type === 'text') inp.value = '';

            await fetch(`${API}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(msg)
            });
            load();
        }

        // –ó–ê–ì–†–£–ó–ö–ê
        async function load() {
            try {
                const res = await fetch(`${API}/messages`);
                const msgs = await res.json();
                if(msgs.length === lastCount) return;
                
                const flow = document.getElementById('chat-flow');
                flow.innerHTML = msgs.map(m => {
                    const isMe = m.email === user.email.toLowerCase();
                    let content = `<span>${m.text || ''}</span>`;
                    
                    if(m.type === 'img') content = `<img src="${m.media}">`;
                    if(m.type === 'vid') content = `<video src="${m.media}" controls></video>`;
                    if(m.type === 'audio') content = `<audio src="${m.media}" controls></audio>`;
                    if(m.type === 'circle') content = `<video src="${m.media}" autoplay loop muted playsinline class="circle-vid"></video>`;

                    return `<div class="msg ${isMe ? 'sent' : 'received'}"><b>${m.nick}</b>${content}</div>`;
                }).join('');
                
                lastCount = msgs.length;
                document.getElementById('sc-chat').scrollTop = document.getElementById('sc-chat').scrollHeight;
            } catch(e) {}
        }

        // –ì–° –ò –ö–†–£–ñ–ö–ò (–£–ü–†–û–©–ï–ù–ù–û –ß–ï–†–ï–ó MEDIA RECORDER)
        async function startVoice() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            record(stream, 'audio');
        }

        async function startCircle() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            record(stream, 'circle');
        }

        function record(stream, type) {
            const chunks = [];
            const rec = new MediaRecorder(stream);
            rec.ondataavailable = e => chunks.push(e.data);
            rec.onstop = async () => {
                const blob = new Blob(chunks, { type: type === 'audio' ? 'audio/ogg' : 'video/webm' });
                const reader = new FileReader();
                reader.onload = (e) => send(type, e.target.result);
                reader.readAsDataURL(blob);
                stream.getTracks().forEach(t => t.stop());
            };
            rec.start();
            alert(type === 'audio' ? "–ó–∞–ø–∏—Å—å –ì–° (5 —Å–µ–∫)..." : "–ó–∞–ø–∏—Å—å –∫—Ä—É–∂–∫–∞ (5 —Å–µ–∫)...");
            setTimeout(() => rec.stop(), 5000); // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∞
        }

        setInterval(load, 2500);
        load();
    </script>
</body>
</html>
