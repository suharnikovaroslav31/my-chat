<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speeky OS | True Base</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --c-main: #00f2ff; --bg: #000; --brd: rgba(255,255,255,0.1); --blur: 20px; --brt: 1; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; }

        /* –§–û–ù */
        .fx-bg { position: fixed; inset: 0; z-index: -1; filter: brightness(var(--brt)); }
        .fx-blob { position: absolute; width: 100vw; height: 100vw; background: radial-gradient(circle, var(--c-main) 0%, transparent 70%); filter: blur(100px); opacity: 0.1; top: -10%; left: -10%; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        .sc { display: none; height: 100vh; padding: 20px; flex-direction: column; max-width: 500px; margin: 0 auto; overflow-y: auto; }
        .sc.on { display: flex; }
        .box { background: rgba(20,20,20,0.9); border: 1px solid var(--brd); border-radius: 20px; backdrop-filter: blur(var(--blur)); padding: 20px; margin-bottom: 15px; }

        input { width: 100%; padding: 15px; background: rgba(255,255,255,0.05); border: 1px solid var(--brd); color: #fff; border-radius: 12px; outline: none; margin-bottom: 10px; }
        .btn { width: 100%; padding: 15px; background: var(--c-main); color: #000; border: none; border-radius: 12px; font-weight: 900; cursor: pointer; }

        /* –ß–ê–¢ */
        #chat-list { display: flex; flex-direction: column; gap: 8px; padding-bottom: 140px; }
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; margin-bottom: 5px; }
        .msg.my { align-self: flex-end; background: var(--c-main); color: #000; }
        .msg.not-my { align-self: flex-start; background: rgba(255,255,255,0.1); border: 1px solid var(--brd); }

        /* –ú–ï–ù–Æ –ò –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #111; border: 1px solid var(--brd); border-radius: 30px; display: flex; padding: 10px; gap: 20px; z-index: 100; }
        .dock-i { font-size: 20px; opacity: 0.4; cursor: pointer; }
        .dock-i.on { opacity: 1; color: var(--c-main); }

        .chat-input-ui { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; display: none; gap: 10px; background: #000; padding: 5px; }
        .chat-input-ui.on { display: flex; }
    </style>
</head>
<body>

    <div class="fx-bg"><div class="fx-blob"></div></div>

    <section id="view-login" class="sc on" style="justify-content:center;">
        <div class="box" style="text-align:center;">
            <h1 style="margin-bottom:20px;">Speeky OS</h1>
            <input type="text" id="in-nick" placeholder="–¢–≤–æ–π –Ω–∏–∫">
            <button class="btn" onclick="sysLogin()">–í–û–ô–¢–ò</button>
        </div>
    </section>

    <div id="view-app" style="display:none;">
        <section id="view-chats" class="sc">
            <h2>–î–∏–∞–ª–æ–≥–∏</h2>
            <div id="contacts-box" style="margin-top:20px;"></div>
            <button onclick="sysAdd()" style="margin-top:20px; color:var(--c-main); background:none; border:none; cursor:pointer;">+ –ù–∞–π—Ç–∏ –ø–æ –Ω–∏–∫—É</button>
        </section>

        <section id="view-room" class="sc">
            <h3 id="room-name" onclick="go('chats')" style="cursor:pointer; margin-bottom:15px;">‚Üê –ù–∞–∑–∞–¥</h3>
            <div id="chat-list"></div>
        </section>

        <section id="view-profile" class="sc">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="box" style="margin-top:20px;">
                <p>–ü—Ä–∏–≤–µ—Ç, <b id="user-display">...</b></p>
                <div style="margin-top:20px;">
                    <label style="font-size:12px;">–†–∞–∑–º—ã—Ç–∏–µ</label>
                    <input type="range" min="0" max="40" value="20" oninput="sysVis('blur', this.value)">
                </div>
                <div style="margin-top:10px;">
                    <label style="font-size:12px;">–Ø—Ä–∫–æ—Å—Ç—å</label>
                    <input type="range" min="0.1" max="2" step="0.1" value="1" oninput="sysVis('brt', this.value)">
                </div>
                <button onclick="sysExit()" style="margin-top:20px; color:red; background:none; border:none; cursor:pointer;">–í—ã–π—Ç–∏</button>
            </div>
        </section>

        <div class="chat-input-ui" id="ui-input">
            <input type="text" id="m-val" placeholder="–¢–µ–∫—Å—Ç..." style="margin:0;">
            <button onclick="sysSend()" style="width:50px; border-radius:12px; background:var(--c-main); border:none;">‚ûî</button>
        </div>

        <nav class="dock">
            <div class="dock-i on" id="btn-chats" onclick="go('chats')">üí¨</div>
            <div class="dock-i" id="btn-profile" onclick="go('profile')">‚öôÔ∏è</div>
        </nav>
    </div>

    <script>
        const API_URL = 'https://my-chat-itp3.onrender.com/messages';
        // –ù–û–í–´–ô –ö–õ–Æ–ß –ß–¢–û–ë–´ –£–ë–ò–¢–¨ –ö–≠–®
        let ME = JSON.parse(localStorage.getItem('SPK_REBORN_BASE'));
        let PEER = null;

        function sysLogin() {
            const n = document.getElementById('in-nick').value.trim();
            if(!n) return;
            ME = { name: n.replace('@','') };
            localStorage.setItem('SPK_REBORN_BASE', JSON.stringify(ME));
            location.reload();
        }

        function startup() {
            if(!ME) return;
            document.getElementById('view-login').classList.remove('on');
            document.getElementById('view-app').style.display = 'block';
            document.getElementById('user-display').innerText = ME.name;
            go('chats');
            setInterval(sync, 3000); sync();
        }

        function go(s) {
            document.querySelectorAll('.sc').forEach(x => x.classList.remove('on'));
            document.getElementById('view-' + s).classList.add('on');
            document.getElementById('ui-input').classList.toggle('on', s === 'room');
            document.querySelectorAll('.dock-i').forEach(i => i.classList.remove('on'));
            const btn = s === 'room' ? 'btn-chats' : 'btn-' + s;
            if(document.getElementById(btn)) document.getElementById(btn).classList.add('on');
        }

        function sysVis(k, v) {
            document.documentElement.style.setProperty(k === 'blur' ? '--blur' : '--brt', k === 'blur' ? v + 'px' : v);
        }

        function sysAdd() {
            const p = prompt("–ù–∏–∫:");
            if(p) { PEER = p.replace('@',''); go('room'); document.getElementById('room-name').innerText = '‚Üê @' + PEER; }
        }

        async function sysSend() {
            const input = document.getElementById('m-val');
            if(!input.value || !PEER) return;
            const data = { from: ME.name, to: PEER, text: input.value, time: Date.now() };
            input.value = '';
            await fetch(API_URL, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
            sync();
        }

        async function sync() {
            try {
                const res = await fetch(API_URL);
                const all = await res.json();
                
                if(PEER) {
                    const box = document.getElementById('chat-list');
                    box.innerHTML = '';
                    all.filter(m => (m.from === ME.name && m.to === PEER) || (m.from === PEER && m.to === ME.name))
                       .forEach(m => {
                           const d = document.createElement('div');
                           d.className = `msg ${m.from === ME.name ? 'my' : 'not-my'}`;
                           d.innerText = m.text;
                           box.appendChild(d);
                       });
                }

                const users = new Set();
                all.forEach(m => { if(m.from === ME.name) users.add(m.to); if(m.to === ME.name) users.add(m.from); });
                const cBox = document.getElementById('contacts-box');
                cBox.innerHTML = '';
                users.forEach(u => {
                    const d = document.createElement('div');
                    d.className = 'box'; d.innerText = '@' + u; d.style.padding = '15px'; d.style.cursor = 'pointer';
                    d.onclick = () => { PEER = u; go('room'); document.getElementById('room-name').innerText = '‚Üê @' + u; };
                    cBox.appendChild(d);
                });
            } catch(e) {}
        }

        function sysExit() { localStorage.clear(); location.reload(); }
        startup();
    </script>
</body>
</html>
