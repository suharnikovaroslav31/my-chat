<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speeky | Elite Evolution</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #00f2ff;
            --accent-rgb: 0, 242, 255;
            --bg: #000;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-deep: rgba(10, 12, 16, 0.98);
            --border: rgba(255, 255, 255, 0.1);
            --spring: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; position: relative; transition: 0.5s ease; }

        /* --- –§–û–ù --- */
        .ether-bg { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% 120%, rgba(var(--accent-rgb), 0.15) 0%, #000 60%); }
        .cloud { position: absolute; width: 140vw; height: 140vw; background: radial-gradient(circle, rgba(var(--accent-rgb), 0.05) 0%, transparent 65%); filter: blur(100px); animation: drift 35s infinite alternate ease-in-out; }
        @keyframes drift { from { transform: translate(-15%, -15%) rotate(0deg); } to { transform: translate(15%, 15%) rotate(20deg); } }

        /* --- –í–ï–†–•–ù–ò–ô –û–°–¢–†–û–í–û–ö --- */
        .island-mini { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); border: 0.5px solid var(--border); padding: 5px 15px; border-radius: 20px; backdrop-filter: blur(15px); z-index: 1000; display: flex; align-items: center; gap: 8px; }
        .live-pulse { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); }

        /* --- –≠–ö–†–ê–ù–´ --- */
        .view { position: absolute; inset: 0; display: none; padding: 80px 25px 130px; flex-direction: column; opacity: 0; transform: scale(1.02); filter: blur(10px); transition: all 0.6s var(--spring); }
        .view.active { display: flex; opacity: 1; transform: scale(1); filter: blur(0px); }

        /* --- –ß–ê–¢–´ --- */
        .chat-card { background: var(--glass); border: 1px solid var(--border); border-radius: 35px; padding: 22px; margin-bottom: 12px; display: flex; align-items: center; gap: 18px; cursor: pointer; transition: 0.4s var(--spring); }
        .chat-card:active { transform: scale(0.96); }
        .avatar { width: 58px; height: 58px; border-radius: 20px; background: linear-gradient(135deg, var(--accent), #555); display: flex; align-items: center; justify-content: center; font-weight: 900; }

        /* --- –°–û–û–ë–©–ï–ù–ò–Ø –ò –†–ï–ê–ö–¶–ò–ò --- */
        #flow { flex: 1; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
        .bubble { max-width: 80%; padding: 14px 20px; border-radius: 24px; font-size: 15px; position: relative; animation: bubbleIn 0.5s var(--spring) forwards; }
        @keyframes bubbleIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .bubble.me { align-self: flex-end; background: var(--accent); color: #000; font-weight: 600; border-bottom-right-radius: 4px; }
        .bubble.he { align-self: flex-start; background: var(--glass); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        
        .reaction-tag { position: absolute; bottom: -10px; right: 10px; background: var(--glass-deep); border: 1px solid var(--border); border-radius: 10px; padding: 2px 6px; font-size: 12px; }

        /* --- –ú–ï–ù–Æ –†–ï–ê–ö–¶–ò–ô --- */
        .reaction-menu { position: fixed; background: var(--glass-deep); border: 1px solid var(--border); border-radius: 20px; padding: 10px; display: none; gap: 10px; z-index: 3000; backdrop-filter: blur(20px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .reaction-menu span { font-size: 24px; cursor: pointer; transition: 0.2s; }
        .reaction-menu span:hover { transform: scale(1.3); }

        /* --- –ò–ù–¢–ï–†–§–ï–ô–° –í–í–û–î–ê --- */
        .input-hub { position: fixed; bottom: 95px; left: 5%; width: 90%; background: var(--glass-deep); border: 1px solid var(--border); border-radius: 30px; display: flex; padding: 5px; backdrop-filter: blur(20px); z-index: 1000; }
        .input-hub input { flex: 1; background: none; border: none; padding: 15px; color: #fff; outline: none; }

        /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø --- */
        .nav-island { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background: rgba(10, 12, 15, 0.9); border: 1px solid var(--border); padding: 10px 30px; border-radius: 40px; backdrop-filter: blur(30px); display: flex; gap: 45px; z-index: 900; }
        .nav-btn { font-size: 24px; opacity: 0.3; cursor: pointer; transition: 0.4s var(--spring); }
        .nav-btn.active { opacity: 1; color: var(--accent); transform: scale(1.2); }

        /* --- –¢–ï–ú–´ --- */
        .theme-dot { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.3s; }
        .theme-dot.active { border-color: #fff; transform: scale(1.1); }

    </style>
</head>
<body oncontextmenu="return false;">

    <div class="ether-bg"><div class="cloud"></div></div>

    <div class="island-mini">
        <div class="live-pulse"></div>
        <span id="sys-status" style="font-size: 9px; font-weight: 900; letter-spacing: 1px;">SPEEKY ELITE ‚Ä¢ <span id="typing-status">ONLINE</span></span>
    </div>

    <div id="rmenu" class="reaction-menu">
        <span onclick="addReaction('üî•')">üî•</span>
        <span onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span onclick="addReaction('üëç')">üëç</span>
        <span onclick="addReaction('üòÇ')">üòÇ</span>
    </div>

    <section id="view-auth" class="view">
        <div style="margin: auto; width: 100%; max-width: 380px; background: var(--glass-deep); padding: 40px; border-radius: 40px; border: 1px solid var(--border);">
            <h1 style="font-size: 32px; font-weight: 900; margin-bottom: 30px;">Speeky Elite</h1>
            <input type="text" id="reg-n" placeholder="@username">
            <input type="email" id="reg-e" placeholder="Email –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è">
            <button onclick="auth()" style="width:100%; padding:20px; background:var(--accent); color:#000; border:none; border-radius:20px; font-weight:900; cursor:pointer;">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
        </div>
    </section>

    <section id="view-chats" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
            <h1 style="font-size: 42px; font-weight: 900;">–ß–∞—Ç—ã</h1>
            <div style="color: var(--accent); font-weight: 600; cursor:pointer;" onclick="openSearch()">+ –ù–∞–π—Ç–∏</div>
        </div>
        <div id="chats-list"></div>
    </section>

    <section id="view-room" class="view">
        <div style="display:flex; align-items:center; gap:20px; margin-bottom:20px;">
            <div onclick="nav('chats')" style="cursor:pointer; font-size: 24px;">‚Üê</div>
            <h2 id="peer-name" style="font-weight: 900;">@username</h2>
        </div>
        <div id="flow"></div>
        <div class="input-hub">
            <input type="text" id="m-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="broadcastTyping()" onkeypress="if(event.key==='Enter') sendMsg()">
            <button onclick="sendMsg()" style="width:45px; height:45px; background:var(--accent); border:none; border-radius:50%; cursor:pointer;">‚ûî</button>
        </div>
    </section>

    <section id="view-sets" class="view">
        <h1 style="font-size: 42px; font-weight: 900; margin-bottom:40px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        <div style="background: var(--glass-deep); border: 1px solid var(--border); border-radius: 40px; padding: 35px;">
            <p style="font-size: 11px; opacity: 0.3; letter-spacing: 2px; margin-bottom: 20px;">–í–´–ë–û–† –¢–ï–ú–´</p>
            <div style="display:flex; gap:15px; margin-bottom:40px;">
                <div class="theme-dot active" style="background:#00f2ff;" onclick="setTheme('#00f2ff', '0, 242, 255', this)"></div>
                <div class="theme-dot" style="background:#7000ff;" onclick="setTheme('#7000ff', '112, 0, 255', this)"></div>
                <div class="theme-dot" style="background:#00ff88;" onclick="setTheme('#00ff88', '0, 255, 136', this)"></div>
                <div class="theme-dot" style="background:#ffcc00;" onclick="setTheme('#ffcc00', '255, 204, 0', this)"></div>
            </div>
            <h3 id="u-info" style="font-size: 24px; color: var(--accent);">@...</h3>
            <button onclick="logout()" style="margin-top:20px; background:none; border:none; color:#ff4d4d; cursor:pointer;">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
        </div>
    </section>

    <nav class="nav-island" id="global-nav" style="display:none;">
        <div class="nav-btn active" id="btn-chats" onclick="nav('chats')">üí¨</div>
        <div class="nav-btn" id="btn-sets" onclick="nav('sets')">‚öôÔ∏è</div>
    </nav>

    <script>
        const API = 'https://my-chat-itp3.onrender.com/messages';
        const KEY = 'SPEEKY_EVO_V3';
        let user = JSON.parse(localStorage.getItem(KEY));
        let peer = null;
        let lastHash = "";
        let selectedMsgId = null;

        function auth() {
            const n = document.getElementById('reg-n').value.trim().replace('@','');
            const e = document.getElementById('reg-e').value.trim();
            if(!n || !e) return;
            user = { name: n, email: e, date: new Date().toLocaleDateString(), theme: '#00f2ff' };
            localStorage.setItem(KEY, JSON.stringify(user));
            location.reload();
        }

        function nav(page) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            setTimeout(() => { document.getElementById('view-' + page).classList.add('active'); }, 50);
            document.getElementById('global-nav').style.display = (page === 'auth') ? 'none' : 'flex';
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const b = document.getElementById('btn-' + (page === 'room' ? 'chats' : page));
            if(b) b.classList.add('active');
        }

        function setTheme(hex, rgb, el) {
            document.documentElement.style.setProperty('--accent', hex);
            document.documentElement.style.setProperty('--accent-rgb', rgb);
            document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            user.theme = hex; user.rgb = rgb;
            localStorage.setItem(KEY, JSON.stringify(user));
        }

        async function sendMsg() {
            const i = document.getElementById('m-in');
            if(!i.value.trim()) return;
            const text = i.value; i.value = '';
            await fetch(API, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ from: user.name, to: peer, text, time: Date.now(), reaction: null }) });
            sync();
        }

        function broadcastTyping() {
            // –ò–º–∏—Ç–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—á–∞—Ç–∏ —á–µ—Ä–µ–∑ –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ API)
            document.getElementById('typing-status').innerText = "TYPING...";
            setTimeout(() => { document.getElementById('typing-status').innerText = "ONLINE"; }, 2000);
        }

        async function sync() {
            try {
                const r = await fetch(API); const d = await r.json();
                const hash = JSON.stringify(d.slice(-10));
                if(hash === lastHash) return; lastHash = hash;

                if(peer) {
                    const flow = document.getElementById('flow');
                    flow.innerHTML = '';
                    d.filter(m => (m.from === user.name && m.to === peer) || (m.from === peer && m.to === user.name))
                     .forEach(m => {
                        const b = document.createElement('div');
                        b.className = `bubble ${m.from === user.name ? 'me' : 'he'}`;
                        b.innerText = m.text;
                        if(m.reaction) b.innerHTML += `<div class="reaction-tag">${m.reaction}</div>`;
                        
                        // –î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π
                        b.onpointerdown = (e) => {
                            selectedMsgId = m._id; 
                            const menu = document.getElementById('rmenu');
                            menu.style.display = 'flex';
                            menu.style.left = e.pageX + 'px';
                            menu.style.top = e.pageY + 'px';
                        };
                        flow.appendChild(b);
                     });
                    flow.scrollTop = flow.scrollHeight;
                }

                const chats = new Set(); d.forEach(m => { if(m.from === user.name) chats.add(m.to); if(m.to === user.name) chats.add(m.from); });
                const list = document.getElementById('chats-list'); list.innerHTML = '';
                chats.forEach(c => {
                    const card = document.createElement('div'); card.className = 'chat-card';
                    card.innerHTML = `<div class="avatar">${c[0].toUpperCase()}</div><div><b style="font-size:19px;">@${c}</b><p style="opacity:0.3; font-size:12px;">Active Session</p></div>`;
                    card.onclick = () => { peer = c; document.getElementById('peer-name').innerText = '@' + c; nav('room'); };
                    list.appendChild(card);
                });
            } catch(e) {}
        }

        function openSearch() {
            const p = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫:");
            if(p) { peer = p.replace('@',''); document.getElementById('peer-name').innerText = '@' + peer; nav('room'); sync(); }
        }

        window.onclick = () => { document.getElementById('rmenu').style.display = 'none'; };

        if(user) {
            document.getElementById('u-info').innerText = '@' + user.name;
            if(user.theme) setTheme(user.theme, user.rgb || '0, 242, 255', document.querySelector(`[style*="${user.theme}"]`));
            nav('chats'); setInterval(sync, 3000); sync();
        } else { nav('auth'); }
        function logout() { localStorage.removeItem(KEY); location.reload(); }
    </script>
</body>
</html>
