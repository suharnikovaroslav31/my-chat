<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speeky OS | Database & Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #9d50ff;
            --bg: #050505;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --island-h: 70px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; position: fixed; width: 100%; }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #auth-layer {
            position: fixed; inset: 0; z-index: 9999; background: var(--bg);
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-card {
            width: 100%; max-width: 360px; background: var(--glass); 
            padding: 40px 30px; border-radius: 35px; border: 1px solid var(--border);
            backdrop-filter: blur(20px); text-align: center;
        }
        .auth-input {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            padding: 16px; border-radius: 18px; color: #fff; outline: none; margin-bottom: 15px;
        }
        .auth-btn {
            width: 100%; padding: 18px; background: var(--accent); border: none;
            border-radius: 18px; color: #fff; font-weight: 700; cursor: pointer;
        }

        /* –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
        #app { display: none; height: 100vh; flex-direction: column; }
        .header { padding: 20px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.5); }
        
        /* –ö–û–ù–¢–ï–ù–¢ */
        .view-section { 
            flex: 1; overflow-y: auto; padding: 20px; display: none; 
            padding-bottom: 150px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –æ—Å—Ç—Ä–æ–≤–æ–∫ */
        }
        .view-section.active { display: flex; flex-direction: column; }

        /* –°–û–û–ë–©–ï–ù–ò–Ø */
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 20px; margin-bottom: 10px; font-size: 15px; line-height: 1.4; }
        .msg.in { background: var(--glass); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid var(--border); }
        .msg.out { background: var(--accent); align-self: flex-end; border-bottom-right-radius: 4px; }

        /* –ü–û–õ–ï –í–í–û–î–ê (FIXED) */
        .input-container {
            padding: 15px 20px 30px; 
            background: linear-gradient(transparent, var(--bg) 20%);
            position: absolute; bottom: 85px; /* –ù–∞–¥ –æ—Å—Ç—Ä–æ–≤–∫–æ–º */
            width: 100%; display: flex; gap: 10px; z-index: 100;
        }
        .m-field { 
            flex: 1; background: #151515; border: 1px solid var(--border); 
            padding: 14px 20px; border-radius: 25px; color: #fff; outline: none;
        }
        .m-field:focus ~ .island-wrap { opacity: 0.2; transform: translate(-50%, 20px); }

        /* DYNAMIC ISLAND */
        .island-wrap {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 380px; z-index: 200;
            transition: 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
        }
        .island {
            background: rgba(20, 20, 25, 0.9); border: 1px solid var(--border);
            border-radius: 35px; padding: 10px; display: flex;
            justify-content: space-around; align-items: center;
            backdrop-filter: blur(30px);
        }
        .nav-icon { font-size: 22px; cursor: pointer; opacity: 0.4; transition: 0.3s; padding: 8px; }
        .nav-icon.active { opacity: 1; color: var(--accent); }

        /* –°–ü–ò–°–ö–ò */
        .list-card { background: var(--glass); padding: 15px; border-radius: 20px; margin-bottom: 10px; border: 1px solid var(--border); }
    </style>
</head>
<body>

    <div id="auth-layer">
        <div class="auth-card">
            <h2 style="margin-bottom:20px">Speeky Cloud</h2>
            <input type="email" id="email" class="auth-input" placeholder="Email">
            <input type="text" id="nick" class="auth-input" placeholder="Nickname">
            <button class="auth-btn" onclick="handleAuth()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —è–¥—Ä–æ</button>
        </div>
    </div>

    <div id="app">
        <header class="header">
            <h2 id="view-title"># –û—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª</h2>
        </header>

        <div id="view-chat" class="view-section active">
            <div id="messages-render"></div>
        </div>

        <div id="view-contacts" class="view-section">
            <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏–∑ –ë–î</h3>
            <div id="contacts-render" style="margin-top:15px"></div>
        </div>

        <div id="view-settings" class="view-section">
            <h3>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã</h3>
            <div class="list-card" style="margin-top:15px">
                <p>–í–µ—Ä—Å–∏—è –ë–î: IndexedDB v1.0</p>
                <p>–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ: AES-GCM</p>
            </div>
            <button onclick="clearDB()" style="color:red; background:none; border:none; margin-top:20px">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
        </div>

        <div class="input-container" id="input-container">
            <input type="text" id="m-input" class="m-field" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button onclick="sendMessage()" style="background:var(--accent); border:none; padding:10px 15px; border-radius:50%">üöÄ</button>
        </div>

        <div class="island-wrap" id="island">
            <div class="island">
                <div class="nav-icon active" onclick="switchTab('chat', this)">üí¨</div>
                <div class="nav-icon" onclick="switchTab('contacts', this)">üë§</div>
                <div class="nav-icon" onclick="switchTab('settings', this)">‚öôÔ∏è</div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let db;
        let currentUser = null;

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–• (IndexedDB) ---
        const request = indexedDB.open("SpeekyDB", 1);
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            db.createObjectStore("messages", { keyPath: "id", autoIncrement: true });
            db.createObjectStore("user", { keyPath: "id" });
        };
        request.onsuccess = (e) => {
            db = e.target.result;
            checkSession();
        };

        // –ü–†–û–í–ï–†–ö–ê –°–ï–°–°–ò–ò
        function checkSession() {
            const transaction = db.transaction(["user"], "readonly");
            const store = transaction.objectStore("user");
            store.get(1).onsuccess = (e) => {
                if (e.target.result) {
                    currentUser = e.target.result;
                    showApp();
                }
            };
        }

        // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ò –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ë–î
        function handleAuth() {
            const email = document.getElementById('email').value;
            const nick = document.getElementById('nick').value;
            if(!email.includes('@')) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π Email");

            currentUser = { id: 1, email, nick };
            const transaction = db.transaction(["user"], "readwrite");
            transaction.objectStore("user").put(currentUser);
            showApp();
        }

        function showApp() {
            document.getElementById('auth-layer').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            socket.emit('authenticate', { username: currentUser.nick });
            loadHistory();
        }

        // –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò –ò–ó –ë–î
        function loadHistory() {
            const transaction = db.transaction(["messages"], "readonly");
            const store = transaction.objectStore("messages");
            store.getAll().onsuccess = (e) => {
                e.target.result.forEach(renderMessage);
            };
        }

        // –†–ê–ë–û–¢–ê –° –°–û–û–ë–©–ï–ù–ò–Ø–ú–ò
        function sendMessage() {
            const inp = document.getElementById('m-input');
            if(!inp.value.trim()) return;
            
            const msgData = { name: currentUser.nick, text: inp.value, time: Date.now() };
            socket.emit('message', msgData);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î
            const transaction = db.transaction(["messages"], "readwrite");
            transaction.objectStore("messages").add(msgData);
            
            inp.value = '';
        }

        socket.on('message', (m) => {
            renderMessage(m);
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á—É–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–∂–µ
            const transaction = db.transaction(["messages"], "readwrite");
            transaction.objectStore("messages").add(m);
        });

        function renderMessage(m) {
            const wrap = document.getElementById('messages-render');
            const isMe = m.name === currentUser.nick;
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'out' : 'in'}`;
            div.innerHTML = isMe ? m.text : `<b>${m.name}</b><br>${m.text}`;
            wrap.appendChild(div);
            document.getElementById('view-chat').scrollTop = wrap.scrollHeight;
        }

        // –ù–ê–í–ò–ì–ê–¶–ò–Ø
        function switchTab(tab, el) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
            document.getElementById('view-' + tab).classList.add('active');
            el.classList.add('active');
            
            const inputContainer = document.getElementById('input-container');
            inputContainer.style.display = (tab === 'chat') ? 'flex' : 'none';
        }

        function clearDB() {
            indexedDB.deleteDatabase("SpeekyDB");
            location.reload();
        }

        // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å—Ç—Ä–æ–≤–æ–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
        const inputField = document.getElementById('m-input');
        inputField.addEventListener('focus', () => {
            document.getElementById('island').style.opacity = "0.1";
            document.getElementById('island').style.pointerEvents = "none";
        });
        inputField.addEventListener('blur', () => {
            document.getElementById('island').style.opacity = "1";
            document.getElementById('island').style.pointerEvents = "all";
        });
    </script>
</body>
</html>
